<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Product</title>
  <style>
    body { font-family: Arial; padding: 2rem; max-width: 600px; margin: auto; }
    label, input, textarea, select, button { display: block; width: 100%; margin-top: 1rem; }
    button { margin-top: 2rem; padding: 0.5rem; background: #28a745; color: white; border: none; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>Add New Product</h2>
  <form id="productForm">
    <input type="hidden" id="id" />
    <input type="hidden" id="brand" value="Crochetastic" />

    <label>Name</label>
    <input type="text" id="name" required />

    <label>Price</label>
    <input type="number" id="price" required />

    <label>Preview Image URL</label>
    <input type="url" id="preview" required />

    <label>Is Accessory?</label>
    <select id="isAccessory">
      <option value="false">Handmade Clothes</option>
      <option value="true">Handmade Stuff</option>
    </select>

    <label>Description</label>
    <textarea id="description" rows="4"></textarea>

    <label>Additional Photo URLs (comma-separated)</label>
    <textarea id="photos" rows="3"></textarea>

    <button type="submit">Add Product</button>
    <p id="status"></p>
  </form>

  <script>
    document.getElementById('productForm').addEventListener('submit', async e => {
      e.preventDefault();
      const status = document.getElementById('status');

      // Get max id from localStorage or 0
      const content = JSON.parse(localStorage.getItem('content') || '[]');
      const lastId = content.length > 0 ? Math.max(...content.map(p => Number(p.id))) : 0;
      const id = lastId + 1;

      const newProduct = {
        id: id.toString(),
        name: document.getElementById('name').value.trim(),
        brand: "Crochetastic",
        price: parseFloat(document.getElementById('price').value),
        preview: document.getElementById('preview').value.trim(),
        isAccessory: document.getElementById('isAccessory').value === 'true'
      };

      const detailedProduct = {
        ...newProduct,
        description: document.getElementById('description').value.trim(),
        photos: document.getElementById('photos').value
          .split(',')
          .map(p => p.trim())
          .filter(p => p)
      };

      try {
        const res = await fetch('/api/addProduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newProduct, detailedProduct })
        });
        const data = await res.json();

        if (res.ok) {
          status.textContent = '✅ Product added (saved temporarily in serverless memory).';
          status.className = 'success';

          // Save locally so data persists in browser
          content.unshift(newProduct);
          localStorage.setItem('content', JSON.stringify(content));

          const contentDetail = JSON.parse(localStorage.getItem('contentdetail') || '[]');
          contentDetail.unshift(detailedProduct);
          localStorage.setItem('contentdetail', JSON.stringify(contentDetail));

          e.target.reset();
        } else {
          throw new Error(data.error || 'Failed to add product');
        }
      } catch (error) {
        status.textContent = `❌ Error: ${error.message}`;
        status.className = 'error';
      }
    });
  </script>
</body>
</html>
